<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Lobby</title>
</head>
<body>
<h1>Lobby</h1>

<table>
    <thead>
    <tr>
        <th>GameName</th>
        <th>Players</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="room : ${rooms}" border="1">
        <td th:text="${room.name}">Room Name</td>
        <td th:text="${room.playerCount} + '/' + '8'">0</td>
        <td>
            <button type="button"
                    class="join-button"
                    th:attr="data-roomid=${room.roomId}">
                Join
            </button>
        </td>
    </tr>
    </tbody>
</table>
<dialog id="createRoomDialog">
    <label for="roomName">Roomname:</label><br>
    <input type="text" placeholder="Roomname" id="roomName"><br>
    <button onclick="createRoomDialog.close()">Cancel</button>
    <button onclick="createNewRoom()">Create Room</button>
</dialog>
<button onclick="createRoomDialog.showModal()">Create new Room</button>
</body>
<script>

    document.getElementById("roomName").addEventListener("keyup", event => {
        if(event.key !== "Enter") return;
        createNewRoom();
        event.preventDefault();
    });

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".join-button").forEach(button => {
            button.addEventListener("click", async () => {
                const roomId = button.getAttribute("data-roomid");
                const token = document.cookie
                    .split("; ")
                    .find(row => row.startsWith("token="))
                    ?.split("=")[1];

                if (!token) {
                    window.location.href = "/";
                    return;
                }

                const response = await fetch("/room/join", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({
                        roomId: roomId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("Joined room:", data);
                    // Maybe redirect or show a success message
                } else {
                    const error = await response.json();
                    alert("Error: " + error.message);
                }
            });
        });
    });


    checkToken();

    async function checkToken() {
        if (!document.cookie.includes("token")) {
            window.location.href = "/";
        }
        let token = document.cookie.split("; ").find(row => row.startsWith("token="))?.split("=")[1];
        const response = await fetch("/secureTest", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: ""
        })
            .then(response => {
                return response.json(); // Parse JSON response
            })
            .then(data => {
                if (data.status !== "verified") {
                    const expires = new Date();
                    expires.setTime(0); // Convert days to milliseconds (300s)
                    document.cookie = `token=; expires=${expires.toUTCString()}; path=/`;
                    window.location.href = "/";
                }
            })
            .catch(error => {
                console.error("Error:", error)
            });
    }

    async function createNewRoom() {
        if (!document.cookie.includes("token")) {
            window.location.href = "/";
        }
        let token = document.cookie.split("; ").find(row => row.startsWith("token="))?.split("=")[1];
        let roomName = document.getElementById("roomName").value;
        const response = await fetch("/room/createRoom", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify({
                "name": roomName
            })
        })
            .then(response => {
                if (response.ok) {
                    document.getElementById("createRoomDialog").close();
                    location.reload();
                }

                console.log(response);
            })
    }


</script>
</html>